<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚·ãƒ³ã‚» Mobile</title>
    <link rel="icon" href="favicon.ico">
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #ccc;
            --accent: #00ffcc;
            --accent-dim: #008866;
            --panic-color: #ff4444;
            --save-color: #ffcc00;
            --guide-color: #ff77dd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px 5px; /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ– */
            overscroll-behavior: none;
        }
        body.panic-active { background-color: #400 !important; }

        /* HEADER */
        header {
            width: 100%; max-width: 940px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px;
            flex-wrap: wrap; /* ãƒ¢ãƒã‚¤ãƒ«ã§æŠ˜ã‚Šè¿”ã— */
            gap: 10px;
        }
        h1 { margin: 0; font-weight: 300; letter-spacing: 1px; color: #fff; font-size: 1.1rem; }
        h1 span { color: var(--accent); font-weight: bold; font-size: 0.8em; margin-left: 5px; }
        
        .header-controls { 
            display: flex; gap: 6px; flex-wrap: wrap; 
            justify-content: flex-end;
        }

        button { font-family: inherit; outline: none; -webkit-tap-highlight-color: transparent; }
        .std-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 8px 12px; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã„ã‚ˆã†ã«å°‘ã—å¤§ãã */
            border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; transition: 0.2s;
            touch-action: manipulation;
        }
        .std-btn:active { transform: translateY(1px); background: #555; }

        .panic-btn { border-color: var(--panic-color); color: var(--panic-color); background: rgba(50,0,0,0.3); }
        .panic-btn:active, .panic-btn.flash { background: var(--panic-color); color: #fff; box-shadow: 0 0 15px var(--panic-color); }
        
        .save-btn { border-color: var(--save-color); color: var(--save-color); background: rgba(50,50,0,0.2); }
        .save-btn:hover { background: var(--save-color); color: #000; }

        .key-btn { border-color: var(--guide-color); color: var(--guide-color); display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤ºæ¨å¥¨ */ }
        @media(min-width: 768px) { .key-btn { display: inline-block; } }

        /* SYNTH PANEL */
        .synth-wrapper {
            background-color: var(--panel-bg);
            border: 1px solid #444; border-radius: 6px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            width: 100%; max-width: 940px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        /* PRESET BAR */
        .preset-bar {
            display: flex; gap: 8px; margin-bottom: 15px;
            overflow-x: auto; padding-bottom: 5px; align-items: center;
            background: #151515; padding: 10px; border-radius: 4px; border: 1px solid #333;
            -webkit-overflow-scrolling: touch; /* ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºï¼ˆè¦‹ãŸç›®ã™ã£ãã‚Šï¼‰ */
        .preset-bar::-webkit-scrollbar { height: 4px; display: none; }
        
        .preset-label { font-size: 0.7rem; font-weight: bold; color: #888; margin-right: 5px; flex-shrink: 0; }
        .preset-chip {
            display: flex; align-items: center; flex-shrink: 0;
            background: #2a2a2a; border: 1px solid #444; border-radius: 3px;
            overflow: hidden; transition: 0.2s;
        }
        .preset-chip.active { border-color: var(--accent); }
        .preset-chip.active .p-name { background: var(--accent-dim); color: #fff; }
        .p-name { padding: 8px 12px; font-size: 0.8rem; cursor: pointer; color: #bbb; white-space: nowrap; }
        .p-name:active { background: #444; color: #fff; }
        .p-del {
            padding: 8px 10px; font-size: 0.8rem; cursor: pointer;
            color: #666; background: #222; border-left: 1px solid #444;
        }

        /* VISUALIZER */
        .visualizer-container {
            background: #000; border: 1px solid #444; border-radius: 4px;
            height: 80px; margin-bottom: 15px; position: relative; cursor: pointer;
            touch-action: none;
        }
        .vis-label {
            position: absolute; top: 4px; right: 6px; font-size: 10px; color: #666; pointer-events: none;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* CONTROLS */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* ãƒ¢ãƒã‚¤ãƒ«ã¯2åˆ— */
            gap: 8px; margin-bottom: 15px;
        }
        @media(min-width: 600px) {
            .controls-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        }

        .module {
            background: #252525; padding: 10px; border-radius: 4px;
            border: 1px solid #3a3a3a;
        }
        .module h3 {
            margin: 0 0 10px 0; font-size: 0.75rem; font-weight: 600;
            color: #888; border-bottom: 2px solid #444; padding-bottom: 4px;
        }
        .param { display: flex; flex-direction: column; margin-bottom: 10px; }
        label { font-size: 0.7rem; margin-bottom: 5px; display: flex; justify-content: space-between; color: #aaa; }
        .val-disp { color: var(--accent); font-family: monospace; font-size: 0.75rem; }

        /* Range Slider Styling for Mobile */
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 24px; /* ã‚¿ãƒƒãƒé ˜åŸŸç¢ºä¿ */
            background: transparent; outline: none; margin: 0; padding: 0;
            touch-action: none; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
        }
        /* Track */
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #111; border-radius: 2px; border: 1px solid #444;
        }
        input[type="range"]::-moz-range-track {
            width: 100%; height: 4px; background: #111; border-radius: 2px; border: 1px solid #444;
        }
        /* Thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #ccc; cursor: pointer; margin-top: -8px; /* track center */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type="range"]::-moz-range-thumb {
            height: 18px; width: 18px; border-radius: 50%; border: none;
            background: #ccc; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        input[type="range"].accent-slider::-webkit-slider-thumb { background: var(--accent); }
        input[type="range"].rev-slider::-webkit-slider-thumb { background: #d0f; }
        input[type="range"].hpf-slider::-webkit-slider-thumb { background: #fa0; }
        
        select { 
            width: 100%; background: #111; color: #eee; border: 1px solid #555; 
            padding: 8px; font-size: 0.8rem; border-radius: 4px;
        }

        /* UTILITY */
        .utility-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 8px; border-radius: 4px; margin-bottom: 0; border: 1px solid #333;
        }
        .utility-group { display: flex; align-items: center; }
        .rec-btn.active { background: #d00; border-color: #f00; color: #fff; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }

        /* PIANO */
        .piano-wrapper {
            position: relative; background: #111; border-top: 1px solid #000;
            padding: 10px 0 20px 0; overflow: hidden; margin-top: 10px;
            touch-action: none; /* éµç›¤æ“ä½œæ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œå…¨ç„¡åŠ¹åŒ– */
        }
        .piano { display: flex; justify-content: center; height: 160px; position: relative; }
        .key { 
            position: relative; border-radius: 0 0 4px 4px; cursor: pointer; 
            display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; 
            touch-action: none;
        }
        .key.white { flex: 1; background: #e0e0e0; border: 1px solid #999; z-index: 1; max-width: 14vw; }
        .key.white.active { background: #bbb; transform: scaleY(0.98); border-bottom: 4px solid var(--accent); }
        .key.black {
            width: 60%; max-width: 9vw; height: 55%; background: #111;
            position: absolute; z-index: 2; left: 0; transform: translateX(-50%);
            border: 1px solid #000; box-shadow: inset 0 0 5px rgba(255,255,255,0.2);
            padding-bottom: 8px; border-radius: 0 0 3px 3px;
        }
        .key.black.active { background: #333; transform: translateX(-50%) scaleY(0.98); border-bottom: 2px solid var(--accent); }

        .key-hint {
            font-size: 10px; color: var(--guide-color); font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .show-hints .key-hint { opacity: 1; }
        /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚­ãƒ¼ãƒ’ãƒ³ãƒˆåŸºæœ¬éè¡¨ç¤º */
        @media(max-width: 767px) { .key-hint { display: none !important; } }

        .midi-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; margin-right: 5px; }
        .midi-dot.on { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        /* HELP */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: #222; border: 1px solid #555; width: 90%; max-width: 600px;
            max-height: 80vh; overflow-y: auto; padding: 20px; color: #ddd;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }
        .modal-content h2 { border-bottom: 1px solid var(--accent); color: var(--accent); margin-top: 0; padding-bottom: 10px; font-size: 1.2rem; }
        .modal-content h3 { font-size: 0.95rem; color: #fff; margin-top: 20px; border-left: 3px solid #555; padding-left: 10px; }
        .modal-content p { font-size: 0.85rem; line-height: 1.6; color: #aaa; margin: 5px 0; }
        .close-modal { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: #fff; margin-top: 20px; cursor: pointer; border-radius: 4px; font-size: 1rem; }

    </style>
</head>
<body>

    <header>
        <h1>Sonic Lab <span>V5 MOBILE</span></h1>
        <div class="header-controls">
            <button class="std-btn" id="init-btn">INIT</button>
            <button class="std-btn key-btn" id="key-btn" title="Show Keyboard Hints">KEY</button>
            <button class="std-btn save-btn" id="save-btn">ğŸ’¾ SAVE</button>
            <button class="std-btn panic-btn" id="panic-btn">ğŸ›‘ PANIC</button>
            <button class="std-btn" id="help-btn">HELP</button>
        </div>
    </header>

    <div class="synth-wrapper">
        <div class="preset-bar" id="preset-bar">
            <!-- JS populated -->
        </div>

        <div class="visualizer-container" id="vis-container" title="Click to Switch Mode">
            <span class="vis-label" id="vis-label">WAVEFORM</span>
            <canvas id="scope"></canvas>
        </div>

        <div class="controls-grid">
            <div class="module">
                <h3>VCO</h3>
                <div class="param">
                    <label>Waveform</label>
                    <select id="osc-type">
                        <option value="sawtooth">Sawtooth</option>
                        <option value="square">Square</option>
                        <option value="triangle">Triangle</option>
                        <option value="sine">Sine</option>
                    </select>
                </div>
                <div class="param">
                    <label>Detune <span class="val-disp" id="val-detune">0</span></label>
                    <input type="range" id="osc-detune" min="-50" max="50" value="0">
                </div>
            </div>

            <div class="module">
                <h3>VCF</h3>
                <div class="param">
                    <label>LPF Cutoff <span class="val-disp" id="val-cutoff">2000Hz</span></label>
                    <input type="range" id="filter-cutoff" class="accent-slider" min="50" max="12000" step="10" value="2000">
                </div>
                <div class="param">
                    <label>Resonance <span class="val-disp" id="val-res">1.0</span></label>
                    <input type="range" id="filter-res" min="0" max="20" step="0.1" value="1">
                </div>
                <div class="param">
                    <label style="color:#fa0;">HPF Cutoff <span class="val-disp" id="val-hpf">0Hz</span></label>
                    <input type="range" id="filter-hpf" class="hpf-slider" min="0" max="8000" step="10" value="0">
                </div>
            </div>

            <div class="module">
                <h3>Envelope</h3>
                <div class="param">
                    <label>Attack</label>
                    <input type="range" id="env-atk" min="0.005" max="2" step="0.005" value="0.05">
                </div>
                <div class="param">
                    <label>Decay</label>
                    <input type="range" id="env-dec" min="0.01" max="2" step="0.01" value="0.3">
                </div>
                <div class="param">
                    <label>Sustain</label>
                    <input type="range" id="env-sus" min="0" max="1" step="0.01" value="0.5">
                </div>
                <div class="param">
                    <label>Release</label>
                    <input type="range" id="env-rel" min="0.01" max="5" step="0.01" value="0.5">
                </div>
            </div>

            <div class="module">
                <h3>Mod / Arp</h3>
                <div class="param">
                    <label>LFO Rate <span class="val-disp" id="val-lfo-rate">5Hz</span></label>
                    <input type="range" id="lfo-rate" min="0.1" max="20" step="0.1" value="5">
                </div>
                <div class="param">
                    <label>LFO Depth</label>
                    <input type="range" id="lfo-depth" min="0" max="100" value="0">
                </div>
                <div class="param" style="flex-direction:row; justify-content:space-between; margin-top:5px; align-items:center;">
                    <label style="margin:0;">Arp</label>
                    <button class="std-btn" id="arp-toggle" style="padding:4px 8px; font-size:0.7rem;">OFF</button>
                </div>
                <div class="param">
                    <label>Speed <span class="val-disp" id="val-arp-speed">120</span></label>
                    <input type="range" id="arp-speed" min="60" max="600" step="10" value="120">
                </div>
            </div>

            <div class="module">
                <h3>FX</h3>
                <div class="param">
                    <label>Delay Mix</label>
                    <input type="range" id="delay-mix" min="0" max="0.7" step="0.01" value="0.2">
                </div>
                <div class="param">
                    <label>Delay Time</label>
                    <input type="range" id="delay-time" min="0.05" max="1.0" step="0.01" value="0.3">
                </div>
                <div class="param">
                    <label style="color:#d0f;">Reverb Mix</label>
                    <input type="range" id="reverb-mix" class="rev-slider" min="0" max="1.5" step="0.01" value="0.0">
                </div>
            </div>
        </div>

        <div class="utility-bar">
            <div class="utility-group">
                <div class="midi-dot" id="midi-dot"></div> <span style="font-size:0.7rem; color:#666; margin-left:4px;">MIDI</span>
            </div>
            <div class="utility-group">
                <button class="std-btn" id="oct-down" style="padding:6px 12px;">OCT -</button>
                <span id="oct-disp" style="font-family:monospace; padding:0 8px; font-size:1.1rem; font-weight:bold;">0</span>
                <button class="std-btn" id="oct-up" style="padding:6px 12px;">OCT +</button>
            </div>
            <div class="utility-group">
                <button class="std-btn rec-btn" id="rec-btn">â— REC</button>
            </div>
        </div>

        <div class="piano-wrapper">
            <div class="piano" id="piano"></div>
        </div>
    </div>

    <!-- HELP -->
<div class="modal-overlay" id="help-modal">
        <div class="modal-content">
            <h2>ä½¿ã„æ–¹ï¼†ç”¨èªã‚¬ã‚¤ãƒ‰</h2>
            
            <h3>ğŸ– åŸºæœ¬æ“ä½œï¼ˆã‚¹ãƒãƒ›ãƒ»PCï¼‰</h3>
            <p><strong>æ¼”å¥ã™ã‚‹:</strong> éµç›¤ã‚’ã‚¿ãƒƒãƒ—ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ã™ã‚‹ã¨éŸ³ãŒé³´ã‚Šã¾ã™ã€‚<br>
            <strong>å’ŒéŸ³ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰:</strong> ã‚¹ãƒãƒ›ã§ã¯è¤‡æ•°ã®æŒ‡ã§åŒæ™‚ã«æŠ¼ã™ã¨å’ŒéŸ³ãŒé³´ã‚Šã¾ã™ã€‚<br>
            <strong>æ»‘ã‚‰ã›ã¦å¼¾ã:</strong> éµç›¤ã®ä¸Šã§æŒ‡ã‚’æ»‘ã‚‰ã›ã‚‹ã¨ã€ã‚°ãƒªãƒƒã‚µãƒ³ãƒ‰ï¼ˆé€£ç¶šéŸ³ï¼‰æ¼”å¥ãŒã§ãã¾ã™ã€‚</p>

            <h3>ğŸ”Š VCOï¼ˆã©ã‚“ãªéŸ³ã‚’å‡ºã™ï¼Ÿï¼‰</h3>
            <p>éŸ³ã®ã€Œç´ æã€ã‚’é¸ã³ã¾ã™ã€‚<br>
            <strong>Waveform (æ³¢å½¢):</strong>
            <ul style="padding-left:20px; margin:5px 0;">
                <li>Sawtooth: ã€Œãƒ“ãƒ¼ã€ã¨ã„ã†é‹­ã„éŸ³ã€‚æ´¾æ‰‹ãªéŸ³ã«æœ€é©ã€‚</li>
                <li>Square: ã€Œãƒãƒ¼ã€ã¨ã„ã†ãƒ•ã‚¡ãƒŸã‚³ãƒ³é¢¨ã®ãƒ¬ãƒˆãƒ­ãªéŸ³ã€‚</li>
                <li>Triangle: ã€Œãƒãƒ¼ã€ã¨ã„ã†è§’ã®å–ã‚ŒãŸä¸¸ã„éŸ³ã€‚</li>
                <li>Sine: ã€Œã‚¦ãƒ¼ã€ã¨ã„ã†ä¸€ç•ªç´”ç²‹ã§å„ªã—ã„éŸ³ã€‚</li>
            </ul>
            <strong>Detune:</strong> éŸ³ã‚’å¾®å¦™ã«ãšã‚‰ã—ã¦ã€åšã¿ã‚„åºƒãŒã‚Šã‚’å‡ºã—ã¾ã™ã€‚</p>

            <h3>ğŸ› VCFï¼ˆéŸ³ã®æ˜ã‚‹ã•ã‚’å¤‰ãˆã‚‹ï¼‰</h3>
            <p>éŸ³ã®æˆåˆ†ã‚’å‰Šã£ã¦ã€éŸ³è‰²ã‚’èª¿æ•´ã—ã¾ã™ã€‚<br>
            <strong>LPF Cutoff:</strong> æ•°å€¤ã‚’ä¸‹ã’ã‚‹ã¨ã€éŸ³ãŒã€Œã“ã‚‚ã£ã¦ã€æš—ããªã‚Šã¾ã™ã€‚ä¸Šã’ã‚‹ã¨ã€Œæ˜ã‚‹ãã€ãªã‚Šã¾ã™ã€‚<br>
            <strong>Resonance:</strong> éŸ³ã®ã‚¯ã‚»ã‚’å¼·ã‚ã¾ã™ã€‚ä¸Šã’ã‚‹ã¨ã€ŒãƒŸãƒ§ãƒ³ãƒŸãƒ§ãƒ³ã€ã€Œãƒ“ãƒ¨ãƒ“ãƒ¨ã€ã—ãŸéŸ³ã«ãªã‚Šã¾ã™ã€‚<br>
            <strong>HPF:</strong> ä½éŸ³ã‚’å‰Šã‚Šã¾ã™ã€‚ä¸Šã’ã‚‹ã¨éŸ³ãŒè»½ãã€ã‚«ãƒªã‚«ãƒªã«ãªã‚Šã¾ã™ã€‚</p>

            <h3>ğŸ“ˆ Envelopeï¼ˆéŸ³ã®å½¢ã‚’å¤‰ãˆã‚‹ï¼‰</h3>
            <p>éŸ³ãŒé³´ã£ã¦ã‹ã‚‰æ¶ˆãˆã‚‹ã¾ã§ã®ã€Œæ™‚é–“ã®å¤‰åŒ–ã€ã‚’ä½œã‚Šã¾ã™ã€‚<br>
            <strong>Attack:</strong> éŸ³ã®ã€Œå‡ºã ã—ã€ã€‚ä¸Šã’ã‚‹ã¨ã€Œãµã‚ã£ã€ã¨é³´ã‚Šå§‹ã‚ã¾ã™ã€‚<br>
            <strong>Decay / Sustain:</strong> éŸ³ã®ã€Œä¼¸ã³ã€ã€‚Sustainã‚’ä¸‹ã’ã‚‹ã¨ãƒ”ã‚¢ãƒã®ã‚ˆã†ã«æ¸›è¡°ã—ã¾ã™ã€‚<br>
            <strong>Release:</strong> éŸ³ã®ã€Œä½™éŸ»ã€ã€‚ä¸Šã’ã‚‹ã¨æŒ‡ã‚’é›¢ã—ãŸå¾Œã‚‚ã—ã°ã‚‰ãéŸ¿ãã¾ã™ã€‚</p>

            <h3>ã€°ï¸ Mod / Arpï¼ˆå‹•ãã‚’ã¤ã‘ã‚‹ï¼‰</h3>
            <p><strong>LFO:</strong> éŸ³ã‚’æºã‚‰ã—ã¾ã™ã€‚ã€Œãƒ“ãƒ–ãƒ©ãƒ¼ãƒˆã€ã‚„ã€Œã‚¦ãƒ¯ã‚¦ãƒ¯ã€ã—ãŸåŠ¹æœã‚’ä½œã‚Šã¾ã™ã€‚<br>
            <strong>Arp (ã‚¢ãƒ«ãƒšã‚¸ã‚¨ãƒ¼ã‚¿ãƒ¼):</strong> ONã«ã—ã¦å’ŒéŸ³ã‚’æŠ¼ã•ãˆã‚‹ã¨ã€ã€Œãƒ‘ãƒ©ãƒ‘ãƒ©ãƒ‘ãƒ©â€¦ã€ã¨è‡ªå‹•ã§åˆ†æ•£ã—ã¦æ¼”å¥ã—ã¦ãã‚Œã¾ã™ã€‚</p>

            <h3>ğŸŒŒ FXï¼ˆç©ºé–“ã®åºƒãŒã‚Šï¼‰</h3>
            <p><strong>Delay:</strong> ã€Œã‚„ã¾ã³ã“ã€åŠ¹æœã§ã™ã€‚éŸ³ãŒé…ã‚Œã¦ç¹°ã‚Šè¿”ã•ã‚Œã¾ã™ã€‚<br>
            <strong>Reverb:</strong> ã€ŒãŠé¢¨å‘‚å ´ã€ã‚„ã€Œãƒ›ãƒ¼ãƒ«ã€ã®ã‚ˆã†ãªéŸ¿ãã‚’åŠ ãˆã¾ã™ã€‚</p>

            <button class="close-modal" id="close-help">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- PRESETS ---
        const factoryPresets = {
            "Init Saw": { oscType:'sawtooth', cutoff:2000, res:1, hpf:0, atk:0.01, dec:0.3, sus:0.8, rel:0.2, lfoDepth:0, delayMix:0, reverbMix:0, arp:false },
            "Deep Space": { oscType:'sawtooth', cutoff:800, res:3, hpf:100, atk:1.0, dec:2.0, sus:0.6, rel:3.0, lfoDepth:20, delayMix:0.5, reverbMix:1.2, arp:false },
            "Acid Bass": { oscType:'square', cutoff:400, res:12, hpf:0, atk:0.01, dec:0.2, sus:0, rel:0.1, lfoDepth:0, delayMix:0.2, reverbMix:0, arp:false },
            "Pluck Lead": { oscType:'sawtooth', cutoff:3000, res:0, hpf:500, atk:0.01, dec:0.1, sus:0, rel:0.4, lfoDepth:0, delayMix:0.4, reverbMix:0.2, arp:true }
        };

        // --- GLOBAL ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        let masterGain, compressor, analyser;
        let delayNode, delayFb, delayMix, revNode, revMix;
        let recStream, mediaRecorder, chunks = [];
        let visMode = 0; // 0: Wave, 1: Spectrum

        const params = {
            oscType: 'sawtooth', detune: 0,
            cutoff: 2000, res: 1, hpf: 0,
            atk: 0.05, dec: 0.3, sus: 0.5, rel: 0.5,
            lfoRate: 5, lfoDepth: 0,
            delayTime: 0.3, delayMix: 0.2, reverbMix: 0.0,
            arpEnabled: false, arpSpeed: 120, arpStyle: 'up',
            octave: 0
        };

        // --- AUDIO ENGINE ---
        function createReverbImpulse(duration, decay) {
            const rate = ctx.sampleRate, len = rate * duration;
            const buffer = ctx.createBuffer(2, len, rate);
            const L = buffer.getChannelData(0), R = buffer.getChannelData(1);
            for(let i=0; i<len; i++) {
                const k = Math.pow(1-i/len, decay);
                L[i] = (Math.random()*2-1)*k; R[i] = (Math.random()*2-1)*k;
            }
            return buffer;
        }

        function initAudio() {
            if(masterGain) return;
            // Mobile Safari needs explicit resume in click event usually, done in noteOn wrapper
            masterGain = ctx.createGain(); masterGain.gain.value = 0.5;
            compressor = ctx.createDynamicsCompressor();
            compressor.threshold.value = -24;
            compressor.knee.value = 30;
            compressor.ratio.value = 12;
            compressor.attack.value = 0.003;
            compressor.release.value = 0.25;

            analyser = ctx.createAnalyser();
            analyser.fftSize = 2048;

            delayNode = ctx.createDelay(); delayNode.delayTime.value = params.delayTime;
            delayFb = ctx.createGain(); delayFb.gain.value = 0.4;
            delayMix = ctx.createGain(); delayMix.gain.value = params.delayMix;
            delayNode.connect(delayFb); delayFb.connect(delayNode); delayNode.connect(delayMix);

            revNode = ctx.createConvolver(); revNode.buffer = createReverbImpulse(3.5, 2.5);
            revMix = ctx.createGain(); revMix.gain.value = params.reverbMix;

            masterGain.connect(compressor);
            compressor.connect(delayNode);
            compressor.connect(revNode);
            revNode.connect(revMix);

            const finalMix = ctx.createGain();
            compressor.connect(finalMix);
            delayMix.connect(finalMix);
            revMix.connect(finalMix);

            finalMix.connect(ctx.destination);
            finalMix.connect(analyser);
            
            const dest = ctx.createMediaStreamDestination();
            finalMix.connect(dest);
            recStream = dest.stream;

            visualize();
        }

        const activeVoices = {};

        function noteOn(midi, velocity=1, duration=0) {
            initAudio(); 
            if(ctx.state === 'suspended') ctx.resume();
            
            if(document.body.classList.contains('panic-active')) return;
            if(params.arpEnabled) { arpKeys.add(midi); startArp(); return; }
            playOsc(midi, velocity, duration);
        }

        function playOsc(midi, velocity, duration) {
            const pitch = midi + (params.octave*12);
            // Don't cut off if it's the same note in poly mode, but standard synth behavior often restarts
            if(duration===0 && activeVoices[pitch]) noteOff(midi, true);

            const t = ctx.currentTime;
            const freq = 440 * Math.pow(2, (pitch-69)/12);
            
            const osc = ctx.createOscillator(); osc.type = params.oscType;
            osc.frequency.setValueAtTime(freq, t); osc.detune.value = params.detune;
            
            const lpf = ctx.createBiquadFilter(); lpf.type = 'lowpass';
            lpf.frequency.setValueAtTime(params.cutoff, t); lpf.Q.value = params.res;
            
            const hpf = ctx.createBiquadFilter(); hpf.type = 'highpass';
            hpf.frequency.setValueAtTime(params.hpf, t);

            const vca = ctx.createGain(); vca.gain.setValueAtTime(0, t);
            
            const a=params.atk, d=params.dec, s=params.sus;
            if(duration>0) {
                vca.gain.linearRampToValueAtTime(velocity, t+0.005);
                vca.gain.setTargetAtTime(0, t+duration*0.8, 0.05);
            } else {
                vca.gain.linearRampToValueAtTime(velocity, t+a);
                vca.gain.setTargetAtTime(velocity*s, t+a+d, 0.2);
            }

            const lfo = ctx.createOscillator(); lfo.frequency.value = params.lfoRate;
            const lfoAmp = ctx.createGain(); lfoAmp.gain.value = params.lfoDepth;
            lfo.connect(lfoAmp); lfoAmp.connect(osc.frequency); lfo.start(t);

            osc.connect(lpf); lpf.connect(hpf); hpf.connect(vca); vca.connect(masterGain);
            osc.start(t);

            const voice = {osc, lfo, vca, lpf, hpf, pitch};
            if(duration>0) {
                osc.stop(t+duration+0.5); setTimeout(()=>delete activeVoices[pitch], (duration+0.5)*1000);
            } else {
                activeVoices[pitch] = voice; drawKey(midi, true);
            }
        }

        function noteOff(midi, force=false) {
            if(params.arpEnabled && !force) { arpKeys.delete(midi); return; }
            const pitch = midi + (params.octave*12);
            const v = activeVoices[pitch];
            if(v) {
                const t = ctx.currentTime;
                v.vca.gain.cancelScheduledValues(t); v.vca.gain.setValueAtTime(v.vca.gain.value, t);
                v.vca.gain.exponentialRampToValueAtTime(0.001, t+params.rel);
                v.osc.stop(t+params.rel+0.1); v.lfo.stop(t+params.rel+0.1);
                delete activeVoices[pitch]; drawKey(midi, false);
            }
        }

        function updateParamsRealtime() {
            if(!delayMix) return;
            const t = ctx.currentTime;
            delayMix.gain.setTargetAtTime(params.delayMix, t, 0.1);
            revMix.gain.setTargetAtTime(params.reverbMix, t, 0.1);
            Object.values(activeVoices).forEach(v => {
                v.lpf.frequency.setTargetAtTime(params.cutoff, t, 0.1);
                v.lpf.Q.setTargetAtTime(params.res, t, 0.1);
                v.hpf.frequency.setTargetAtTime(params.hpf, t, 0.1);
            });
        }

        // --- ARPEGGIATOR ---
        const arpKeys = new Set();
        let arpTimer = null, arpIdx = 0;
        function startArp() {
            if(arpKeys.size===0) { clearInterval(arpTimer); arpTimer=null; return; }
            if(!arpTimer) { arpTimer = setInterval(arpStep, 60000/params.arpSpeed/2); arpStep(); }
        }
        function arpStep() {
            if(arpKeys.size===0) return;
            const keys = Array.from(arpKeys).sort((a,b)=>a-b);
            let playKeys = params.arpStyle==='down' ? keys.slice().reverse() :
                           params.arpStyle==='updown' ? keys.concat(keys.slice(0,-1).reverse()) : keys;
            if(params.arpStyle==='random') playKeys=keys;
            
            let note = params.arpStyle==='random' ? playKeys[Math.floor(Math.random()*playKeys.length)] :
                       playKeys[arpIdx % playKeys.length];
            if(params.arpStyle!=='random') arpIdx++;
            
            const dur = (60/params.arpSpeed)*0.8;
            playOsc(note+(params.octave*12), 0.8, dur);
            drawKey(note, true); setTimeout(()=>drawKey(note,false), 100);
        }

        // --- VISUALIZER ---
        const canvas = document.getElementById('scope');
        const cCtx = canvas.getContext('2d');
        const dataArr = new Uint8Array(2048);
        const visLabel = document.getElementById('vis-label');

        document.getElementById('vis-container').onclick = () => {
            visMode = (visMode + 1) % 2;
            visLabel.innerText = visMode === 0 ? "WAVEFORM" : "SPECTRUM";
        };

        function visualize() {
            requestAnimationFrame(visualize);
            if(canvas.width !== canvas.clientWidth) { canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
            if(!analyser) return;

            cCtx.fillStyle = '#000'; cCtx.fillRect(0,0,canvas.width,canvas.height);
            cCtx.lineWidth = 2; cCtx.strokeStyle = '#00ffcc';

            if(visMode === 0) {
                analyser.getByteTimeDomainData(dataArr);
                cCtx.beginPath();
                const slice = canvas.width/2048; let x=0;
                for(let i=0; i<2048; i++) {
                    const y = (dataArr[i]/128.0)*canvas.height/2;
                    i===0?cCtx.moveTo(x,y):cCtx.lineTo(x,y); x+=slice;
                }
                cCtx.stroke();
            } else {
                analyser.getByteFrequencyData(dataArr);
                const barW = (canvas.width / 128) * 2.5;
                let x = 0;
                for(let i=0; i<128; i++) {
                    const h = (dataArr[i]/255) * canvas.height;
                    cCtx.fillStyle = `hsl(${i*2}, 100%, 50%)`;
                    cCtx.fillRect(x, canvas.height-h, barW, h);
                    x += barW + 1;
                }
            }
        }

        // --- PRESETS ---
        const presetBar = document.getElementById('preset-bar');
        let userPresets = JSON.parse(localStorage.getItem('sonic_v5_presets')||'{}');

        function drawPresets() {
            presetBar.innerHTML = '<span class="preset-label">BANK:</span>';
            for(let name in factoryPresets) {
                const c = document.createElement('div'); c.className='preset-chip';
                const b = document.createElement('div'); b.className='p-name'; b.innerText=name;
                b.onclick=()=>loadPreset(factoryPresets[name]);
                c.appendChild(b); presetBar.appendChild(c);
            }
            for(let name in userPresets) {
                const c = document.createElement('div'); c.className='preset-chip active';
                c.style.borderColor='var(--save-color)';
                const b = document.createElement('div'); b.className='p-name'; b.innerText=name;
                b.style.color='var(--save-color)'; b.onclick=()=>loadPreset(userPresets[name]);
                const d = document.createElement('div'); d.className='p-del'; d.innerText='Ã—';
                d.onclick=(e)=>{ e.stopPropagation(); if(confirm(`Delete "${name}"?`)){ delete userPresets[name]; localStorage.setItem('sonic_v5_presets', JSON.stringify(userPresets)); drawPresets(); }};
                c.appendChild(b); c.appendChild(d); presetBar.appendChild(c);
            }
        }

        function loadPreset(p) {
            Object.assign(params, p);
            const map = {
                oscType:'osc-type', detune:'osc-detune', cutoff:'filter-cutoff', res:'filter-res', hpf:'filter-hpf',
                atk:'env-atk', dec:'env-dec', sus:'env-sus', rel:'env-rel', lfoRate:'lfo-rate', lfoDepth:'lfo-depth',
                delayMix:'delay-mix', delayTime:'delay-time', reverbMix:'reverb-mix', arpSpeed:'arp-speed'
            };
            for(let k in map) {
                const el = document.getElementById(map[k]);
                if(el && p[k]!==undefined) el.value = p[k];
            }
            toggleArp(p.arpEnabled);
            updateDisplays(); updateParamsRealtime();
        }

        document.getElementById('save-btn').onclick = () => {
            const name = prompt("ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ä¿å­˜:");
            if(name) {
                userPresets[name] = {...params};
                localStorage.setItem('sonic_v5_presets', JSON.stringify(userPresets));
                drawPresets();
            }
        };

        document.getElementById('init-btn').onclick = () => { if(confirm("è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) loadPreset(factoryPresets["Init Saw"]); };

        function updateDisplays() {
            document.getElementById('val-detune').innerText = params.detune;
            document.getElementById('val-cutoff').innerText = params.cutoff+'Hz';
            document.getElementById('val-res').innerText = params.res;
            document.getElementById('val-hpf').innerText = params.hpf+'Hz';
            document.getElementById('val-lfo-rate').innerText = params.lfoRate+'Hz';
            document.getElementById('val-arp-speed').innerText = params.arpSpeed;
        }

        document.querySelectorAll('input[type="range"], select').forEach(el => {
            // Touch move prevent default to avoid scrolling
            el.addEventListener('touchmove', e => e.stopPropagation(), {passive: true});
            
            el.addEventListener('input', e => {
                const id=e.target.id; const v=e.target.type==='range'?parseFloat(e.target.value):e.target.value;
                if(id==='osc-type') params.oscType=v; if(id==='osc-detune') params.detune=v;
                if(id==='filter-cutoff') params.cutoff=v; if(id==='filter-res') params.res=v; if(id==='filter-hpf') params.hpf=v;
                if(id==='env-atk') params.atk=v; if(id==='env-dec') params.dec=v; if(id==='env-sus') params.sus=v; if(id==='env-rel') params.rel=v;
                if(id==='lfo-rate') params.lfoRate=v; if(id==='lfo-depth') params.lfoDepth=v;
                if(id==='delay-mix') params.delayMix=v; if(id==='delay-time') { params.delayTime=v; if(delayNode) delayNode.delayTime.linearRampToValueAtTime(v, ctx.currentTime+0.1); }
                if(id==='reverb-mix') params.reverbMix=v; if(id==='arp-speed') params.arpSpeed=v;
                updateDisplays(); updateParamsRealtime();
            });
        });

        const arpBtn = document.getElementById('arp-toggle');
        function toggleArp(state) {
            params.arpEnabled=state; arpBtn.innerText=state?'ON':'OFF';
            arpBtn.style.background = state?'var(--accent)':'#333';
            if(!state) { clearInterval(arpTimer); arpTimer=null; arpKeys.clear(); }
        }
        arpBtn.onclick=()=>toggleArp(!params.arpEnabled);

        const octD = document.getElementById('oct-disp');
        document.getElementById('oct-down').onclick=()=>{if(params.octave>-2)params.octave--; octD.innerText=params.octave;};
        document.getElementById('oct-up').onclick=()=>{if(params.octave<2)params.octave++; octD.innerText=params.octave;};

        const keyBtn = document.getElementById('key-btn');
        const pianoEl = document.getElementById('piano');
        keyBtn.onclick = () => {
            pianoEl.classList.toggle('show-hints');
            keyBtn.classList.toggle('active');
        };

        const panicBtn = document.getElementById('panic-btn');
        panicBtn.onclick = () => {
            document.body.classList.add('panic-active'); panicBtn.classList.add('flash');
            if(masterGain) {
                const t=ctx.currentTime; masterGain.gain.cancelScheduledValues(t); masterGain.gain.setValueAtTime(0,t);
                if(delayMix) delayMix.gain.setValueAtTime(0,t); if(revMix) revMix.gain.setValueAtTime(0,t);
            }
            clearInterval(arpTimer); arpTimer=null; arpKeys.clear();
            Object.values(activeVoices).forEach(v=>{try{v.osc.stop();v.lfo.stop();}catch(e){}});
            for(let k in activeVoices) delete activeVoices[k];
            setTimeout(()=>{
                document.body.classList.remove('panic-active'); panicBtn.classList.remove('flash');
                if(masterGain) masterGain.gain.setTargetAtTime(0.5,ctx.currentTime,0.5);
                if(delayMix) delayMix.gain.setTargetAtTime(params.delayMix,ctx.currentTime,0.5);
                if(revMix) revMix.gain.setTargetAtTime(params.reverbMix,ctx.currentTime,0.5);
            },600);
        };

        // --- KEYS ---
        const keysEl = []; let wC=0;
        const pcKeyMap = "ZSXDCVGBHNJMQ2W3ER5T6Y7UI".split('');
        for(let i=48; i<=72; i++) {
            const isB = [1,3,6,8,10].includes(i%12);
            const k = document.createElement('div');
            k.className = `key ${isB?'black':'white'}`;
            k.dataset.midi = i;
            // Hint
            const hint = document.createElement('span');
            hint.className = 'key-hint';
            const char = pcKeyMap[i-48];
            if(char) hint.innerText = char;
            k.appendChild(hint);

            if(isB) k.style.left = ((wC*100/15)-(100/15/2))+'%'; else wC++;
            pianoEl.appendChild(k);
            keysEl.push({midi:i, el:k});
        }
        function drawKey(m,on) {
            const dM=m+(params.octave*-12);
            const k=keysEl.find(x=>x.midi===dM);
            if(k) on?k.el.classList.add('active'):k.el.classList.remove('active');
        }

        // --- MOUSE & TOUCH EVENTS (Mobile Optimized) ---
        let isMouseDown = false;

        // Helper to get midi from element
        const getMidiFromEl = (el) => {
            if(!el) return null;
            if(el.classList.contains('key')) return parseInt(el.dataset.midi);
            if(el.parentNode && el.parentNode.classList.contains('key')) return parseInt(el.parentNode.dataset.midi);
            return null;
        };

        // Mouse Events (PC)
        pianoEl.addEventListener('mousedown', e => {
            isMouseDown = true;
            const m = getMidiFromEl(e.target);
            if(m !== null) noteOn(m);
        });
        window.addEventListener('mouseup', () => {
            isMouseDown = false;
            // Turn off all keys triggered by mouse if not arp
            if(!params.arpEnabled) {
                // Simplified: just turn off keys that were active via mouse logic
                // For safety, scanning visual keys
                keysEl.forEach(k => { if(k.el.classList.contains('active')) noteOff(k.midi); });
            } else {
                arpKeys.clear();
            }
        });
        pianoEl.addEventListener('mouseover', e => {
            if(isMouseDown) {
                const m = getMidiFromEl(e.target);
                if(m !== null) noteOn(m);
            }
        });
        pianoEl.addEventListener('mouseout', e => {
            if(isMouseDown) {
                const m = getMidiFromEl(e.target);
                if(m !== null) noteOff(m);
            }
        });

        // Touch Events (Mobile Multi-touch)
        const activeTouches = {}; // identifier -> midiNote

        pianoEl.addEventListener('touchstart', e => {
            e.preventDefault(); // Prevent scrolling/zooming
            for(let i=0; i < e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                const el = document.elementFromPoint(t.clientX, t.clientY);
                const m = getMidiFromEl(el);
                if(m !== null) {
                    activeTouches[t.identifier] = m;
                    noteOn(m);
                }
            }
        }, {passive: false});

        pianoEl.addEventListener('touchmove', e => {
            e.preventDefault(); // Enable glissando
            for(let i=0; i < e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                const el = document.elementFromPoint(t.clientX, t.clientY);
                const m = getMidiFromEl(el);
                
                // If finger moved to a new key
                if(m !== null && activeTouches[t.identifier] !== m) {
                    // Turn off old note
                    if(activeTouches[t.identifier] !== undefined) {
                        noteOff(activeTouches[t.identifier]);
                    }
                    // Start new note
                    activeTouches[t.identifier] = m;
                    noteOn(m);
                } else if(m === null && activeTouches[t.identifier] !== undefined) {
                    // Finger moved off keyboard
                    noteOff(activeTouches[t.identifier]);
                    delete activeTouches[t.identifier];
                }
            }
        }, {passive: false});

        const handleTouchEnd = (e) => {
            e.preventDefault();
            for(let i=0; i < e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                const m = activeTouches[t.identifier];
                if(m !== undefined) {
                    noteOff(m);
                    delete activeTouches[t.identifier];
                }
            }
        };
        pianoEl.addEventListener('touchend', handleTouchEnd);
        pianoEl.addEventListener('touchcancel', handleTouchEnd);


        // PC Keys
        const kMap={}; pcKeyMap.forEach((k,i)=>kMap[k]=48+i);
        window.addEventListener('keydown',e=>{if(!e.repeat&&kMap[e.key.toUpperCase()]) noteOn(kMap[e.key.toUpperCase()]);});
        window.addEventListener('keyup',e=>{if(kMap[e.key.toUpperCase()]) noteOff(kMap[e.key.toUpperCase()]);});
        
        // REC
        const recBtn=document.getElementById('rec-btn');
        recBtn.onclick=()=>{
            initAudio(); // Ensure audio context
            if(!mediaRecorder||mediaRecorder.state==='inactive'){
                chunks=[]; mediaRecorder=new MediaRecorder(recStream);
                mediaRecorder.ondataavailable=e=>chunks.push(e.data);
                mediaRecorder.onstop=()=>{
                    const f=prompt("ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å:", `sonic_rec_${Date.now()}`);
                    if(!f)return;
                    const b=new Blob(chunks,{'type':'audio/webm'});
                    const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=f+".webm"; a.click();
                };
                mediaRecorder.start(); recBtn.classList.add('active'); recBtn.innerText='â–  STOP';
            } else { mediaRecorder.stop(); recBtn.classList.remove('active'); recBtn.innerText='â— REC'; }
        };

        // MIDI
        if(navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(a=>{a.inputs.forEach(i=>i.onmidimessage=m=>{const[c,n,v]=m.data; if(c===144&&v>0){noteOn(n,v/127); document.getElementById('midi-dot').classList.add('on');} if(c===128||(c===144&&v===0)){noteOff(n); document.getElementById('midi-dot').classList.remove('on');}});});

        // Modal
        const modal=document.getElementById('help-modal');
        document.getElementById('help-btn').onclick=()=>modal.classList.add('open');
        document.getElementById('close-help').onclick=()=>modal.classList.remove('open');
        modal.onclick=(e)=>{if(e.target===modal)modal.classList.remove('open');};

        // Init
        drawPresets(); updateDisplays();
    </script>
</body>
</html>
