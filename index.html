<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Ç™„Éº„Éá„Ç£„Ç™„Ç∑„É≥„Çª</title>
    <link rel="icon" href="favicon.ico">
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #ccc;
            --accent: #00ffcc;
            --accent-dim: #008866;
            --panic-color: #ff4444;
            --save-color: #ffcc00;
            --guide-color: #ff77dd;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            user-select: none;
            touch-action: none;
            transition: background 0.1s;
        }
        body.panic-active { background-color: #400 !important; }

        /* HEADER */
        header {
            width: 100%; max-width: 940px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; color: #fff; font-size: 1.2rem; }
        h1 span { color: var(--accent); font-weight: bold; font-size: 0.8em; margin-left: 5px; }
        .header-controls { display: flex; gap: 8px; }

        button { font-family: inherit; outline: none; }
        .std-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 5px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.75rem; transition: 0.2s;
        }
        .std-btn:hover { background: #444; border-color: #777; }
        .std-btn:active { transform: translateY(1px); }

        .panic-btn { border-color: var(--panic-color); color: var(--panic-color); background: rgba(50,0,0,0.3); }
        .panic-btn:active, .panic-btn.flash { background: var(--panic-color); color: #fff; box-shadow: 0 0 15px var(--panic-color); }
        
        .save-btn { border-color: var(--save-color); color: var(--save-color); background: rgba(50,50,0,0.2); }
        .save-btn:hover { background: var(--save-color); color: #000; }

        .key-btn { border-color: var(--guide-color); color: var(--guide-color); }
        .key-btn.active { background: var(--guide-color); color: #000; }

        /* SYNTH PANEL */
        .synth-wrapper {
            background-color: var(--panel-bg);
            border: 1px solid #444; border-radius: 6px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            width: 100%; max-width: 940px;
            box-sizing: border-box;
        }

        /* PRESET BAR */
        .preset-bar {
            display: flex; gap: 6px; margin-bottom: 15px;
            overflow-x: auto; padding-bottom: 5px; align-items: center;
            background: #151515; padding: 8px; border-radius: 4px; border: 1px solid #333;
        }
        .preset-label { font-size: 0.7rem; font-weight: bold; color: #888; margin-right: 5px; }
        .preset-chip {
            display: flex; align-items: center;
            background: #2a2a2a; border: 1px solid #444; border-radius: 3px;
            overflow: hidden; transition: 0.2s;
        }
        .preset-chip.active { border-color: var(--accent); }
        .preset-chip.active .p-name { background: var(--accent-dim); color: #fff; }
        .p-name { padding: 4px 8px; font-size: 0.75rem; cursor: pointer; color: #bbb; white-space: nowrap; }
        .p-name:hover { color: #fff; background: #333; }
        .p-del {
            padding: 4px 6px; font-size: 0.7rem; cursor: pointer;
            color: #666; background: #222; border-left: 1px solid #444;
        }
        .p-del:hover { background: #d00; color: #fff; }

        /* VISUALIZER */
        .visualizer-container {
            background: #000; border: 1px solid #444; border-radius: 4px;
            height: 64px; margin-bottom: 15px; position: relative; cursor: pointer;
        }
        .visualizer-container:hover { border-color: var(--accent); }
        .vis-label {
            position: absolute; top: 4px; right: 6px; font-size: 10px; color: #666; pointer-events: none;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* CONTROLS */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px; margin-bottom: 15px;
        }
        .module {
            background: #252525; padding: 10px; border-radius: 4px;
            border: 1px solid #3a3a3a;
        }
        .module h3 {
            margin: 0 0 10px 0; font-size: 0.7rem; font-weight: 600;
            color: #888; border-bottom: 2px solid #444; padding-bottom: 4px;
        }
        .param { display: flex; flex-direction: column; margin-bottom: 8px; }
        label { font-size: 0.65rem; margin-bottom: 3px; display: flex; justify-content: space-between; color: #aaa; }
        .val-disp { color: var(--accent); font-family: monospace; font-size: 0.7rem; }

        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: #111; border-radius: 2px; outline: none; border: 1px solid #444;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 10px; height: 14px;
            background: #ccc; border-radius: 1px; cursor: pointer;
        }
        input[type="range"].accent-slider::-webkit-slider-thumb { background: var(--accent); }
        input[type="range"].rev-slider::-webkit-slider-thumb { background: #d0f; }
        input[type="range"].hpf-slider::-webkit-slider-thumb { background: #fa0; }
        select { width: 100%; background: #111; color: #eee; border: 1px solid #555; padding: 4px; font-size: 0.7rem; }

        /* UTILITY */
        .utility-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 8px; border-radius: 4px; margin-bottom: 0; border: 1px solid #333;
        }
        .rec-btn.active { background: #d00; border-color: #f00; color: #fff; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }

        /* PIANO */
        .piano-wrapper {
            position: relative; background: #111; border-top: 1px solid #000;
            padding: 10px 0 5px 0; overflow: hidden; margin-top: 10px;
        }
        .piano { display: flex; justify-content: center; height: 150px; position: relative; }
        .key { position: relative; border-radius: 0 0 3px 3px; cursor: pointer; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; }
        .key.white { flex: 1; background: #e0e0e0; border: 1px solid #999; z-index: 1; max-width: 50px; }
        .key.white.active { background: #ccc; transform: scaleY(0.98); border-bottom: 4px solid var(--accent); }
        .key.black {
            width: 60%; max-width: 32px; height: 60%; background: #111;
            position: absolute; z-index: 2; left: 0; transform: translateX(-50%);
            border: 1px solid #000; box-shadow: inset 0 0 5px rgba(255,255,255,0.2);
            padding-bottom: 8px;
        }
        .key.black.active { background: #333; transform: translateX(-50%) scaleY(0.98); border-bottom: 2px solid var(--accent); }

        .key-hint {
            font-size: 10px; color: var(--guide-color); font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .key.black .key-hint { color: #fff; font-size: 9px; }
        .show-hints .key-hint { opacity: 1; }

        .midi-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; margin-right: 5px; }
        .midi-dot.on { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        /* HELP */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: #222; border: 1px solid #555; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; padding: 25px; color: #ddd;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .modal-content h2 { border-bottom: 1px solid var(--accent); color: var(--accent); margin-top: 0; padding-bottom: 10px; }
        .modal-content h3 { font-size: 0.95rem; color: #fff; margin-top: 20px; border-left: 3px solid #555; padding-left: 10px; }
        .modal-content p { font-size: 0.85rem; line-height: 1.6; color: #aaa; margin: 5px 0; }
        .close-modal { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; margin-top: 20px; cursor: pointer; }

    </style>
</head>
<body>

    <header>
        <h1>Sonic Lab <span>V5 MASTER</span></h1>
        <div class="header-controls">
            <button class="std-btn" id="init-btn">INIT</button>
            <button class="std-btn key-btn" id="key-btn" title="Show Keyboard Hints">‚å® KEY</button>
            <button class="std-btn save-btn" id="save-btn">üíæ SAVE</button>
            <button class="std-btn panic-btn" id="panic-btn">üõë PANIC</button>
            <button class="std-btn" id="help-btn">HELP</button>
        </div>
    </header>

    <div class="synth-wrapper">
        <div class="preset-bar" id="preset-bar">
            <!-- JS populated -->
        </div>

        <div class="visualizer-container" id="vis-container" title="Click to Switch Mode">
            <span class="vis-label" id="vis-label">WAVEFORM</span>
            <canvas id="scope"></canvas>
        </div>

        <div class="controls-grid">
            <div class="module">
                <h3>VCO</h3>
                <div class="param">
                    <label>Waveform</label>
                    <select id="osc-type">
                        <option value="sawtooth">Sawtooth</option>
                        <option value="square">Square</option>
                        <option value="triangle">Triangle</option>
                        <option value="sine">Sine</option>
                    </select>
                </div>
                <div class="param">
                    <label>Detune <span class="val-disp" id="val-detune">0</span></label>
                    <input type="range" id="osc-detune" min="-50" max="50" value="0">
                </div>
            </div>

            <div class="module">
                <h3>VCF</h3>
                <div class="param">
                    <label>LPF Cutoff <span class="val-disp" id="val-cutoff">2000Hz</span></label>
                    <input type="range" id="filter-cutoff" class="accent-slider" min="50" max="12000" step="10" value="2000">
                </div>
                <div class="param">
                    <label>Resonance <span class="val-disp" id="val-res">1.0</span></label>
                    <input type="range" id="filter-res" min="0" max="20" step="0.1" value="1">
                </div>
                <div class="param">
                    <label style="color:#fa0;">HPF Cutoff <span class="val-disp" id="val-hpf">0Hz</span></label>
                    <input type="range" id="filter-hpf" class="hpf-slider" min="0" max="8000" step="10" value="0">
                </div>
            </div>

            <div class="module">
                <h3>Envelope</h3>
                <div class="param">
                    <label>Attack</label>
                    <input type="range" id="env-atk" min="0.005" max="2" step="0.005" value="0.05">
                </div>
                <div class="param">
                    <label>Decay</label>
                    <input type="range" id="env-dec" min="0.01" max="2" step="0.01" value="0.3">
                </div>
                <div class="param">
                    <label>Sustain</label>
                    <input type="range" id="env-sus" min="0" max="1" step="0.01" value="0.5">
                </div>
                <div class="param">
                    <label>Release</label>
                    <input type="range" id="env-rel" min="0.01" max="5" step="0.01" value="0.5">
                </div>
            </div>

            <div class="module">
                <h3>Mod / Arp</h3>
                <div class="param">
                    <label>LFO Rate <span class="val-disp" id="val-lfo-rate">5Hz</span></label>
                    <input type="range" id="lfo-rate" min="0.1" max="20" step="0.1" value="5">
                </div>
                <div class="param">
                    <label>LFO Depth</label>
                    <input type="range" id="lfo-depth" min="0" max="100" value="0">
                </div>
                <div class="param" style="flex-direction:row; justify-content:space-between; margin-top:5px;">
                    <label>Arp</label>
                    <button class="std-btn" id="arp-toggle" style="padding:2px 6px; font-size:0.6rem;">OFF</button>
                </div>
                <div class="param">
                    <label>Speed <span class="val-disp" id="val-arp-speed">120</span></label>
                    <input type="range" id="arp-speed" min="60" max="600" step="10" value="120">
                </div>
            </div>

            <div class="module">
                <h3>FX</h3>
                <div class="param">
                    <label>Delay Mix</label>
                    <input type="range" id="delay-mix" min="0" max="0.7" step="0.01" value="0.2">
                </div>
                <div class="param">
                    <label>Delay Time</label>
                    <input type="range" id="delay-time" min="0.05" max="1.0" step="0.01" value="0.3">
                </div>
                <div class="param">
                    <label style="color:#d0f;">Reverb Mix</label>
                    <input type="range" id="reverb-mix" class="rev-slider" min="0" max="1.5" step="0.01" value="0.0">
                </div>
            </div>
        </div>

        <div class="utility-bar">
            <div class="utility-group">
                <div class="midi-dot" id="midi-dot"></div> <span style="font-size:0.7rem; color:#666;">MIDI</span>
            </div>
            <div class="utility-group">
                <button class="std-btn" id="oct-down">OCT -</button>
                <span id="oct-disp" style="font-family:monospace; padding:0 5px;">0</span>
                <button class="std-btn" id="oct-up">OCT +</button>
            </div>
            <div class="utility-group">
                <button class="std-btn rec-btn" id="rec-btn">‚óè REC</button>
            </div>
        </div>

        <div class="piano-wrapper">
            <div class="piano show-hints" id="piano"></div>
        </div>
    </div>

    <!-- HELP -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-content">
            <h2>Manual & Specs</h2>
            <h3>VCO (Oscillator)</h3>
            <p><strong>Waveform:</strong> Sawtooth(Èã≠„ÅÑ/‰∏áËÉΩ), Square(‰∏≠Á©∫/„Ç≤„Éº„É†), Triangle(‰∏∏„ÅÑ), Sine(Á¥îÁ≤ã)„ÄÇ<br>
            <strong>Detune:</strong> Èü≥Á®ã„ÇíÂæÆÁ¥∞„Å´„Åö„Çâ„Åó„ÄÅÂéö„Åø„ÇíÂá∫„Åó„Åæ„Åô„ÄÇ</p>
            <h3>VCF (Filter)</h3>
            <p><strong>LPF (Low Pass):</strong> È´òÈü≥„ÇíÂâä„Çä„ÄÅÈü≥„ÇíÊöó„Åè/Â§™„Åè„Åó„Åæ„Åô„ÄÇ<br>
            <strong>Resonance:</strong> „Ç´„ÉÉ„Éà„Ç™„ÉïÁÇπ„ÇíÂº∑Ë™ø„Åó„ÄÅÈü≥„Å´Áôñ„Çí„Å§„Åë„Åæ„Åô„ÄÇ<br>
            <strong>HPF (High Pass):</strong> ‰ΩéÈü≥„ÇíÂâä„Çä„ÄÅÈü≥„ÇíËªΩ„Åè/„Ç´„É™„Ç´„É™„Å´„Åó„Åæ„Åô„ÄÇ</p>
            <h3>Envelope (ADSR)</h3>
            <p>Èü≥„ÅÆÊôÇÈñìÁöÑÂ§âÂåñ„ÄÇAttack(Á´ã„Å°‰∏ä„Åå„Çä)„ÄÅDecay/Sustain(Ê∏õË°∞„ÉªÁ∂≠ÊåÅ)„ÄÅRelease(‰ΩôÈüª)„ÄÇ</p>
            <h3>FX</h3>
            <p><strong>Delay:</strong> „ÇÑ„Åæ„Å≥„ÅìÂäπÊûú„ÄÇ<br><strong>Reverb:</strong> Á©∫ÈñìÊÆãÈüøÔºà„Éõ„Éº„É´ÂäπÊûúÔºâ„ÄÇ</p>
            <h3>Other Features</h3>
            <p><strong>Arp:</strong> ÂíåÈü≥„ÇíÂàÜÊï£„Åï„Åõ„Å¶Ëá™ÂãïÊºîÂ•è„Åó„Åæ„Åô„ÄÇ<br>
            <strong>Visualizer:</strong> „ÇØ„É™„ÉÉ„ÇØ„Åß„ÄåÊ≥¢ÂΩ¢„Äç„Å®„ÄåÂë®Ê≥¢Êï∞ÂàÜÂ∏É„Äç„ÇíÂàá„ÇäÊõø„ÅàÂèØËÉΩ„ÄÇ<br>
            <strong>KEY„Éú„Çø„É≥:</strong> ÈçµÁõ§„Å´ÂØæÂøú„Åô„ÇãPC„Ç≠„Éº„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ</p>
            <button class="close-modal" id="close-help">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <script>
        // --- PRESETS ---
        const factoryPresets = {
            "Init Saw": { oscType:'sawtooth', cutoff:2000, res:1, hpf:0, atk:0.01, dec:0.3, sus:0.8, rel:0.2, lfoDepth:0, delayMix:0, reverbMix:0, arp:false },
            "Deep Space": { oscType:'sawtooth', cutoff:800, res:3, hpf:100, atk:1.0, dec:2.0, sus:0.6, rel:3.0, lfoDepth:20, delayMix:0.5, reverbMix:1.2, arp:false },
            "Acid Bass": { oscType:'square', cutoff:400, res:12, hpf:0, atk:0.01, dec:0.2, sus:0, rel:0.1, lfoDepth:0, delayMix:0.2, reverbMix:0, arp:false },
            "Pluck Lead": { oscType:'sawtooth', cutoff:3000, res:0, hpf:500, atk:0.01, dec:0.1, sus:0, rel:0.4, lfoDepth:0, delayMix:0.4, reverbMix:0.2, arp:true }
        };

        // --- GLOBAL ---
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        let masterGain, compressor, analyser;
        let delayNode, delayFb, delayMix, revNode, revMix;
        let recStream, mediaRecorder, chunks = [];
        let visMode = 0; // 0: Wave, 1: Spectrum

        const params = {
            oscType: 'sawtooth', detune: 0,
            cutoff: 2000, res: 1, hpf: 0,
            atk: 0.05, dec: 0.3, sus: 0.5, rel: 0.5,
            lfoRate: 5, lfoDepth: 0,
            delayTime: 0.3, delayMix: 0.2, reverbMix: 0.0,
            arpEnabled: false, arpSpeed: 120, arpStyle: 'up',
            octave: 0
        };

        // --- AUDIO ENGINE ---
        function createReverbImpulse(duration, decay) {
            const rate = ctx.sampleRate, len = rate * duration;
            const buffer = ctx.createBuffer(2, len, rate);
            const L = buffer.getChannelData(0), R = buffer.getChannelData(1);
            for(let i=0; i<len; i++) {
                const k = Math.pow(1-i/len, decay);
                L[i] = (Math.random()*2-1)*k; R[i] = (Math.random()*2-1)*k;
            }
            return buffer;
        }

        function initAudio() {
            if(masterGain) return;
            masterGain = ctx.createGain(); masterGain.gain.value = 0.5;
            compressor = ctx.createDynamicsCompressor();
            // Mastering settings for limiter feel
            compressor.threshold.value = -24;
            compressor.knee.value = 30;
            compressor.ratio.value = 12;
            compressor.attack.value = 0.003;
            compressor.release.value = 0.25;

            analyser = ctx.createAnalyser();
            analyser.fftSize = 2048;

            delayNode = ctx.createDelay(); delayNode.delayTime.value = params.delayTime;
            delayFb = ctx.createGain(); delayFb.gain.value = 0.4;
            delayMix = ctx.createGain(); delayMix.gain.value = params.delayMix;
            delayNode.connect(delayFb); delayFb.connect(delayNode); delayNode.connect(delayMix);

            revNode = ctx.createConvolver(); revNode.buffer = createReverbImpulse(3.5, 2.5);
            revMix = ctx.createGain(); revMix.gain.value = params.reverbMix;

            // Routing: Voice -> Master -> Compressor -> [Split]
            masterGain.connect(compressor);
            compressor.connect(delayNode);
            compressor.connect(revNode);
            revNode.connect(revMix);

            const finalMix = ctx.createGain();
            compressor.connect(finalMix);
            delayMix.connect(finalMix);
            revMix.connect(finalMix);

            finalMix.connect(ctx.destination);
            finalMix.connect(analyser);
            
            const dest = ctx.createMediaStreamDestination();
            finalMix.connect(dest);
            recStream = dest.stream;

            visualize();
        }

        const activeVoices = {};

        function noteOn(midi, velocity=1, duration=0) {
            initAudio(); if(ctx.state==='suspended') ctx.resume();
            if(document.body.classList.contains('panic-active')) return;
            if(params.arpEnabled) { arpKeys.add(midi); startArp(); return; }
            playOsc(midi, velocity, duration);
        }

        function playOsc(midi, velocity, duration) {
            const pitch = midi + (params.octave*12);
            if(duration===0 && activeVoices[pitch]) noteOff(midi, true);

            const t = ctx.currentTime;
            const freq = 440 * Math.pow(2, (pitch-69)/12);
            
            const osc = ctx.createOscillator(); osc.type = params.oscType;
            osc.frequency.setValueAtTime(freq, t); osc.detune.value = params.detune;
            
            const lpf = ctx.createBiquadFilter(); lpf.type = 'lowpass';
            lpf.frequency.setValueAtTime(params.cutoff, t); lpf.Q.value = params.res;
            
            const hpf = ctx.createBiquadFilter(); hpf.type = 'highpass';
            hpf.frequency.setValueAtTime(params.hpf, t);

            const vca = ctx.createGain(); vca.gain.setValueAtTime(0, t);
            
            // Envelope
            const a=params.atk, d=params.dec, s=params.sus;
            if(duration>0) {
                vca.gain.linearRampToValueAtTime(velocity, t+0.005);
                vca.gain.setTargetAtTime(0, t+duration*0.8, 0.05);
            } else {
                vca.gain.linearRampToValueAtTime(velocity, t+a);
                vca.gain.setTargetAtTime(velocity*s, t+a+d, 0.2);
            }

            const lfo = ctx.createOscillator(); lfo.frequency.value = params.lfoRate;
            const lfoAmp = ctx.createGain(); lfoAmp.gain.value = params.lfoDepth;
            lfo.connect(lfoAmp); lfoAmp.connect(osc.frequency); lfo.start(t);

            osc.connect(lpf); lpf.connect(hpf); hpf.connect(vca); vca.connect(masterGain);
            osc.start(t);

            const voice = {osc, lfo, vca, lpf, hpf, pitch};
            if(duration>0) {
                osc.stop(t+duration+0.5); setTimeout(()=>delete activeVoices[pitch], (duration+0.5)*1000);
            } else {
                activeVoices[pitch] = voice; drawKey(midi, true);
            }
        }

        function noteOff(midi, force=false) {
            if(params.arpEnabled && !force) { arpKeys.delete(midi); return; }
            const pitch = midi + (params.octave*12);
            const v = activeVoices[pitch];
            if(v) {
                const t = ctx.currentTime;
                v.vca.gain.cancelScheduledValues(t); v.vca.gain.setValueAtTime(v.vca.gain.value, t);
                v.vca.gain.exponentialRampToValueAtTime(0.001, t+params.rel);
                v.osc.stop(t+params.rel+0.1); v.lfo.stop(t+params.rel+0.1);
                delete activeVoices[pitch]; drawKey(midi, false);
            }
        }

        // --- UPDATES ---
        function updateParamsRealtime() {
            if(!delayMix) return;
            const t = ctx.currentTime;
            delayMix.gain.setTargetAtTime(params.delayMix, t, 0.1);
            revMix.gain.setTargetAtTime(params.reverbMix, t, 0.1);
            Object.values(activeVoices).forEach(v => {
                v.lpf.frequency.setTargetAtTime(params.cutoff, t, 0.1);
                v.lpf.Q.setTargetAtTime(params.res, t, 0.1);
                v.hpf.frequency.setTargetAtTime(params.hpf, t, 0.1);
            });
        }

        // --- ARPEGGIATOR ---
        const arpKeys = new Set();
        let arpTimer = null, arpIdx = 0;
        function startArp() {
            if(arpKeys.size===0) { clearInterval(arpTimer); arpTimer=null; return; }
            if(!arpTimer) { arpTimer = setInterval(arpStep, 60000/params.arpSpeed/2); arpStep(); }
        }
        function arpStep() {
            if(arpKeys.size===0) return;
            const keys = Array.from(arpKeys).sort((a,b)=>a-b);
            let playKeys = params.arpStyle==='down' ? keys.slice().reverse() :
                           params.arpStyle==='updown' ? keys.concat(keys.slice(0,-1).reverse()) : keys;
            if(params.arpStyle==='random') playKeys=keys;
            
            let note = params.arpStyle==='random' ? playKeys[Math.floor(Math.random()*playKeys.length)] :
                       playKeys[arpIdx % playKeys.length];
            if(params.arpStyle!=='random') arpIdx++;
            
            const dur = (60/params.arpSpeed)*0.8;
            playOsc(note+(params.octave*12), 0.8, dur);
            drawKey(note, true); setTimeout(()=>drawKey(note,false), 100);
        }

        // --- VISUALIZER (Wave/Spectrum) ---
        const canvas = document.getElementById('scope');
        const cCtx = canvas.getContext('2d');
        const dataArr = new Uint8Array(2048);
        const visLabel = document.getElementById('vis-label');

        document.getElementById('vis-container').onclick = () => {
            visMode = (visMode + 1) % 2;
            visLabel.innerText = visMode === 0 ? "WAVEFORM" : "SPECTRUM";
        };

        function visualize() {
            requestAnimationFrame(visualize);
            if(canvas.width !== canvas.clientWidth) { canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
            if(!analyser) return;

            cCtx.fillStyle = '#000'; cCtx.fillRect(0,0,canvas.width,canvas.height);
            cCtx.lineWidth = 2; cCtx.strokeStyle = '#00ffcc';

            if(visMode === 0) { // Waveform
                analyser.getByteTimeDomainData(dataArr);
                cCtx.beginPath();
                const slice = canvas.width/2048; let x=0;
                for(let i=0; i<2048; i++) {
                    const y = (dataArr[i]/128.0)*canvas.height/2;
                    i===0?cCtx.moveTo(x,y):cCtx.lineTo(x,y); x+=slice;
                }
                cCtx.stroke();
            } else { // Spectrum
                analyser.getByteFrequencyData(dataArr);
                const barW = (canvas.width / 128) * 2.5;
                let x = 0;
                for(let i=0; i<128; i++) { // Show low-mid freqs mainly
                    const h = (dataArr[i]/255) * canvas.height;
                    cCtx.fillStyle = `hsl(${i*2}, 100%, 50%)`;
                    cCtx.fillRect(x, canvas.height-h, barW, h);
                    x += barW + 1;
                }
            }
        }

        // --- PRESETS & SAVE ---
        const presetBar = document.getElementById('preset-bar');
        let userPresets = JSON.parse(localStorage.getItem('sonic_v5_presets')||'{}');

        function drawPresets() {
            presetBar.innerHTML = '<span class="preset-label">BANK:</span>';
            // Factory
            for(let name in factoryPresets) {
                const c = document.createElement('div'); c.className='preset-chip';
                const b = document.createElement('div'); b.className='p-name'; b.innerText=name;
                b.onclick=()=>loadPreset(factoryPresets[name]);
                c.appendChild(b); presetBar.appendChild(c);
            }
            // User
            for(let name in userPresets) {
                const c = document.createElement('div'); c.className='preset-chip active';
                c.style.borderColor='var(--save-color)';
                const b = document.createElement('div'); b.className='p-name'; b.innerText=name;
                b.style.color='var(--save-color)'; b.onclick=()=>loadPreset(userPresets[name]);
                const d = document.createElement('div'); d.className='p-del'; d.innerText='√ó';
                d.onclick=(e)=>{ e.stopPropagation(); if(confirm(`Delete "${name}"?`)){ delete userPresets[name]; localStorage.setItem('sonic_v5_presets', JSON.stringify(userPresets)); drawPresets(); }};
                c.appendChild(b); c.appendChild(d); presetBar.appendChild(c);
            }
        }

        function loadPreset(p) {
            Object.assign(params, p);
            // GUI Update
            const map = {
                oscType:'osc-type', detune:'osc-detune', cutoff:'filter-cutoff', res:'filter-res', hpf:'filter-hpf',
                atk:'env-atk', dec:'env-dec', sus:'env-sus', rel:'env-rel', lfoRate:'lfo-rate', lfoDepth:'lfo-depth',
                delayMix:'delay-mix', delayTime:'delay-time', reverbMix:'reverb-mix', arpSpeed:'arp-speed'
            };
            for(let k in map) {
                const el = document.getElementById(map[k]);
                if(el && p[k]!==undefined) el.value = p[k];
            }
            toggleArp(p.arpEnabled);
            updateDisplays(); updateParamsRealtime();
        }

        document.getElementById('save-btn').onclick = () => {
            const name = prompt("„Éó„É™„Çª„ÉÉ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶‰øùÂ≠ò:");
            if(name) {
                userPresets[name] = {...params};
                localStorage.setItem('sonic_v5_presets', JSON.stringify(userPresets));
                drawPresets();
            }
        };

        document.getElementById('init-btn').onclick = () => { if(confirm("Ë®≠ÂÆö„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü")) loadPreset(factoryPresets["Init Saw"]); };

        // --- GUI HANDLING ---
        function updateDisplays() {
            document.getElementById('val-detune').innerText = params.detune;
            document.getElementById('val-cutoff').innerText = params.cutoff+'Hz';
            document.getElementById('val-res').innerText = params.res;
            document.getElementById('val-hpf').innerText = params.hpf+'Hz';
            document.getElementById('val-lfo-rate').innerText = params.lfoRate+'Hz';
            document.getElementById('val-arp-speed').innerText = params.arpSpeed;
        }

        document.querySelectorAll('input[type="range"], select').forEach(el => {
            el.addEventListener('input', e => {
                const id=e.target.id; const v=e.target.type==='range'?parseFloat(e.target.value):e.target.value;
                if(id==='osc-type') params.oscType=v; if(id==='osc-detune') params.detune=v;
                if(id==='filter-cutoff') params.cutoff=v; if(id==='filter-res') params.res=v; if(id==='filter-hpf') params.hpf=v;
                if(id==='env-atk') params.atk=v; if(id==='env-dec') params.dec=v; if(id==='env-sus') params.sus=v; if(id==='env-rel') params.rel=v;
                if(id==='lfo-rate') params.lfoRate=v; if(id==='lfo-depth') params.lfoDepth=v;
                if(id==='delay-mix') params.delayMix=v; if(id==='delay-time') { params.delayTime=v; if(delayNode) delayNode.delayTime.linearRampToValueAtTime(v, ctx.currentTime+0.1); }
                if(id==='reverb-mix') params.reverbMix=v; if(id==='arp-speed') params.arpSpeed=v;
                updateDisplays(); updateParamsRealtime();
            });
        });

        const arpBtn = document.getElementById('arp-toggle');
        function toggleArp(state) {
            params.arpEnabled=state; arpBtn.innerText=state?'ON':'OFF';
            arpBtn.style.background = state?'var(--accent)':'#333';
            if(!state) { clearInterval(arpTimer); arpTimer=null; arpKeys.clear(); }
        }
        arpBtn.onclick=()=>toggleArp(!params.arpEnabled);

        const octD = document.getElementById('oct-disp');
        document.getElementById('oct-down').onclick=()=>{if(params.octave>-2)params.octave--; octD.innerText=params.octave;};
        document.getElementById('oct-up').onclick=()=>{if(params.octave<2)params.octave++; octD.innerText=params.octave;};

        // Key hints
        const keyBtn = document.getElementById('key-btn');
        const pianoEl = document.getElementById('piano');
        keyBtn.onclick = () => {
            pianoEl.classList.toggle('show-hints');
            keyBtn.classList.toggle('active');
        };

        // Panic
        const panicBtn = document.getElementById('panic-btn');
        panicBtn.onclick = () => {
            document.body.classList.add('panic-active'); panicBtn.classList.add('flash');
            if(masterGain) {
                const t=ctx.currentTime; masterGain.gain.cancelScheduledValues(t); masterGain.gain.setValueAtTime(0,t);
                if(delayMix) delayMix.gain.setValueAtTime(0,t); if(revMix) revMix.gain.setValueAtTime(0,t);
            }
            clearInterval(arpTimer); arpTimer=null; arpKeys.clear();
            Object.values(activeVoices).forEach(v=>{try{v.osc.stop();v.lfo.stop();}catch(e){}});
            for(let k in activeVoices) delete activeVoices[k];
            setTimeout(()=>{
                document.body.classList.remove('panic-active'); panicBtn.classList.remove('flash');
                if(masterGain) masterGain.gain.setTargetAtTime(0.5,ctx.currentTime,0.5);
                if(delayMix) delayMix.gain.setTargetAtTime(params.delayMix,ctx.currentTime,0.5);
                if(revMix) revMix.gain.setTargetAtTime(params.reverbMix,ctx.currentTime,0.5);
            },600);
        };

        // --- KEYS ---
        const keysEl = []; let wC=0;
        const pcKeyMap = "ZSXDCVGBHNJMQ2W3ER5T6Y7UI".split('');
        for(let i=48; i<=72; i++) {
            const isB = [1,3,6,8,10].includes(i%12);
            const k = document.createElement('div');
            k.className = `key ${isB?'black':'white'}`;
            k.dataset.midi = i;
            // Hint
            const hint = document.createElement('span');
            hint.className = 'key-hint';
            const char = pcKeyMap[i-48];
            if(char) hint.innerText = char;
            k.appendChild(hint);

            if(isB) k.style.left = ((wC*100/15)-(100/15/2))+'%'; else wC++;
            pianoEl.appendChild(k);
            keysEl.push({midi:i, el:k});
        }
        function drawKey(m,on) {
            const dM=m+(params.octave*-12);
            const k=keysEl.find(x=>x.midi===dM);
            if(k) on?k.el.classList.add('active'):k.el.classList.remove('active');
        }

        // Input Listeners
        let isDown=false;
        const getM = e => e.target.classList.contains('key')?parseInt(e.target.dataset.midi):
                          e.target.parentNode.classList.contains('key')?parseInt(e.target.parentNode.dataset.midi):null;
        pianoEl.addEventListener('mousedown',e=>{isDown=true; const m=getM(e); if(m) noteOn(m);});
        window.addEventListener('mouseup',()=>{isDown=false; keysEl.forEach(k=>{if(k.el.classList.contains('active')&&!params.arpEnabled)noteOff(k.midi);}); if(params.arpEnabled) arpKeys.clear();});
        pianoEl.addEventListener('mouseover',e=>{if(isDown){const m=getM(e); if(m) noteOn(m);}});
        pianoEl.addEventListener('mouseout',e=>{if(isDown){const m=getM(e); if(m) noteOff(m);}});
        
        // PC Keys
        const kMap={}; pcKeyMap.forEach((k,i)=>kMap[k]=48+i);
        window.addEventListener('keydown',e=>{if(!e.repeat&&kMap[e.key.toUpperCase()]) noteOn(kMap[e.key.toUpperCase()]);});
        window.addEventListener('keyup',e=>{if(kMap[e.key.toUpperCase()]) noteOff(kMap[e.key.toUpperCase()]);});
        
        // REC
        const recBtn=document.getElementById('rec-btn');
        recBtn.onclick=()=>{
            if(!mediaRecorder||mediaRecorder.state==='inactive'){
                initAudio(); chunks=[]; mediaRecorder=new MediaRecorder(recStream);
                mediaRecorder.ondataavailable=e=>chunks.push(e.data);
                mediaRecorder.onstop=()=>{
                    const f=prompt("‰øùÂ≠ò„Éï„Ç°„Ç§„É´Âêç:", `sonic_rec_${Date.now()}`);
                    if(!f)return;
                    const b=new Blob(chunks,{'type':'audio/webm'});
                    const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=f+".webm"; a.click();
                };
                mediaRecorder.start(); recBtn.classList.add('active'); recBtn.innerText='‚ñ† STOP';
            } else { mediaRecorder.stop(); recBtn.classList.remove('active'); recBtn.innerText='‚óè REC'; }
        };

        // MIDI
        if(navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(a=>{a.inputs.forEach(i=>i.onmidimessage=m=>{const[c,n,v]=m.data; if(c===144&&v>0){noteOn(n,v/127); document.getElementById('midi-dot').classList.add('on');} if(c===128||(c===144&&v===0)){noteOff(n); document.getElementById('midi-dot').classList.remove('on');}});});

        // Modal
        const modal=document.getElementById('help-modal');
        document.getElementById('help-btn').onclick=()=>modal.classList.add('open');
        document.getElementById('close-help').onclick=()=>modal.classList.remove('open');
        modal.onclick=(e)=>{if(e.target===modal)modal.classList.remove('open');};

        // Init
        drawPresets(); updateDisplays();
    </script>
</body>
</html>